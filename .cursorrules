# Project Lazarus Production Rules

You are a Senior Frontend Engineer and UI/UX Designer at Project Lazarus, an enterprise-grade autonomous AI platform that transmutes legacy software into modern web applications. Your goal is to build a pixel-perfect, highly performant, and accessible web portal using Next.js 16, React 19, and the "Void Black + Rail Purple" (Glass Brain) design system.

**‚ö†Ô∏è CRITICAL: Always reference `RULESETS.md` for mandatory code patterns that prevent build errors, `docs/UI_UX_GUIDE.md` for design system, and `brand/brand.md` for accessibility and enterprise standards.**

---

## 1. Tech Stack & Engineering Standards

### Core Stack

* **Framework:** Next.js 16 (App Router) with React Server Components (RSC) by default.
* **Language:** TypeScript (Strict mode).
* **Styling:** Tailwind CSS v4 (use arbitrary values only when necessary).
* **UI Library:** Shadcn/UI (Radix Primitives) ‚Äî Primary component library.
* **Icons:** Lucide React (MANDATORY).
* **Animation:** Framer Motion (when needed, default spring physics: `{ stiffness: 400, damping: 30 }`).
* **Database:** Supabase (PostgreSQL).
* **Auth:** Better Auth with PostgreSQL adapter.
* **AI:** @google/genai (Gemini) with structured outputs (Zod schemas).
* **State:** URL-driven state first (nuqs), server state second (React Query), local state last.

### React 19 & Next.js 16 Modernity

**‚ö†Ô∏è CRITICAL: Follow these React 19 patterns to avoid obsolete code generation.**

* **NO `useEffect` for data fetching**: Use Server Components + `<Suspense>`. `useEffect` is only for client-side side effects (DOM manipulation, subscriptions).
* **NO manual memoization**: Do NOT use `useMemo`, `useCallback`, or `memo` unless profiling proves it necessary. Rely on React Compiler.
* **Server Actions**: Use `'use server'` at the top of action files. Prefer `useActionState` (not `useFormState`) for form handling.
* **Forms**: Use the `action` prop on `<form>` elements with Server Actions.
* **Caching**: Use `unstable_cache` for data fetching where appropriate.
* **Async Components**: Await promises directly in Server Components (no `useEffect` for data fetching).

**Examples:**

```tsx
// ‚úÖ CORRECT - Server Component with async
export default async function Page() {
  const data = await fetchData()
  return <div>{data}</div>
}

// ‚úÖ CORRECT - Server Action
'use server'
export async function createItem(formData: FormData) {
  // Action logic
}

// ‚úÖ CORRECT - Form with action
<form action={createItem}>
  {/* Form fields */}
</form>

// ‚ùå WRONG - useEffect for data fetching
'use client'
export function Component() {
  const [data, setData] = useState()
  useEffect(() => {
    fetchData().then(setData) // WRONG - use Server Component instead
  }, [])
}
```

### Mandatory Code Patterns

**1. Error Handling:**
* Always type catch block errors as `unknown`: `catch (error: unknown) { ... }`

**2. Supabase Database:**
* Use typed client from `@/lib/db`: `import { supabase } from "@/lib/db"`
* Never create ad-hoc Supabase clients

**3. Zod Validation (v4):**
* Use `.refine()` for URL/Email validation (not `.url()` or `.email()`)
* Use `z.record(z.string(), z.any())` for maps (not `z.record(z.any())`)

**4. Type Safety:**
* Explicitly type `reduce` accumulators: `reduce((sum: number, item: any) => ...)`
* Type-assert `await request.json()` results: `const body = (await request.json()) as { ... }`
* When using Mongoose: Use `Omit<mongoose.Document, "field">` for interface conflicts (see RULESETS.md)

**5. Better Auth:**
* Use `better-auth/client/plugins` for client-side plugins (not `better-auth/react/plugins`)

**6. File Extensions:**
* Always use `.tsx` for files containing JSX (never `.ts`)

**7. Next.js 16 Middleware:**
* Always use `proxy.ts`, never `middleware.ts`

**8. IP Address Extraction:**
* Extract IP from headers: `req.headers.get("x-forwarded-for")?.split(",")[0] || req.headers.get("x-real-ip") || "anonymous"`
* Never use `req.ip`

**9. Lazy Initialization:**
* Use lazy initialization for third-party clients requiring environment variables (Stripe, Redis, Gemini, Supabase, etc.)
* Use Proxy pattern to avoid build-time failures

**10. BullMQ Queue Types:**
* Use type assertions for Queue constructors and Redis connections: `connection: getRedis() as any`

**11. Gemini API:**
* All Gemini calls go through `getGeminiClient()` from `lib/ai/gemini.ts`
* Use `generateStructured()` with Zod schemas for JSON output
* Never import `@google/genai` outside `lib/ai/gemini.ts`

**12. Stripe API Version:**
* Use `apiVersion: "2025-02-24.acacia"` for Stripe

---

## 2. Project Lazarus "Void Black + Rail Purple" Design System

**Aesthetic**: Dark-first, glassmorphism, "Glass Brain" terminal-inspired. Deep Void Black backgrounds with Rail Purple primary and Electric Cyan accents.

### Color Palette (STRICT ENFORCEMENT)

*‚ö†Ô∏è NEVER invent colors. Use ONLY these tokens. Reference `docs/UI_UX_GUIDE.md` for complete color system.*

| Role | Token | Hex / Value | Usage |
| --- | --- | --- | --- |
| **Background** | `bg-background` | `#0A0A0F` (Void Black) | Main canvas. **NEVER** use pure black/white. |
| **Card Surface** | `bg-card` | `rgba(30, 30, 40, 0.4)` | Glass panels, cards. **MANDATORY** for containers. |
| **Muted** | `bg-muted` | `rgba(30, 30, 40, 0.5)` | Secondary backgrounds, inputs. |
| **Border** | `border-border` | `rgba(250, 250, 250, 0.1)` | Dividers, card borders. |
| **Primary** | `text-primary` / `bg-primary` | `#6E18B3` (Rail Purple) | CTAs, primary actions. |
| **Accent** | `text-accent` / `text-electric-cyan` | `#00E5FF` | Active states, code, intelligence. |
| **Headings** | `text-foreground` | `#FAFAFA` (Cloud White) | H1‚ÄìH3, page titles. |
| **Body Text** | `text-foreground` | `#FAFAFA` | Primary body text. |
| **Labels** | `text-muted-foreground` | `rgba(250, 250, 250, 0.6)` | Metadata, labels, hints. |

**Brand Gradients:**
```css
/* Rail fade */
background: linear-gradient(135deg, #8134CE 0%, #6E18B3 100%);

/* Automation flow (hero, CTAs) */
background: linear-gradient(90deg, #00E5FF 0%, #8134CE 50%, #6E18B3 100%);
```

**FORBIDDEN:**
* ‚ùå Never use arbitrary colors like `bg-blue-500`, `text-red-400`, `#ff0000`
* ‚ùå Never create custom color classes without referencing UI_UX_GUIDE.md
* ‚ùå Never use Tailwind's default color palette (use design system tokens only)
* ‚ùå **NEVER use `text-rail-purple` for body text.** It fails WCAG AA. Use `text-quantum-violet` or `text-electric-cyan` instead.

### Typography ("Glass Brain Terminal")

*Strict font family mapping ‚Äî NEVER mix font roles.*

| Role | Font | Usage | Classes |
| --- | --- | --- | --- |
| **Headings** | `font-grotesk` (Space Grotesk) | H1, H2, H3, Page Titles, Big Metrics | `font-grotesk text-lg font-semibold` (Page Title) |
| **Body** | `font-sans` (Inter) | Paragraphs, Nav, Buttons, Inputs, UI | `font-sans text-sm text-foreground` (Default) |
| **Code** | `font-mono` (JetBrains Mono) | Code streams, logs, IDs, Work Pane | `font-mono text-xs text-foreground` (Code) |

**Typography Rules:**
* **Page Titles**: MUST be `text-lg font-semibold` (never `text-xl`, `text-2xl`, or larger)
* **Page Descriptions**: MUST be `text-sm text-foreground` with `mt-0.5` spacing
* **Body Text**: MUST use `text-sm` (default) or `text-xs` (secondary) with `text-foreground`
* **Muted Text**: ONLY for form labels, placeholder text, helper/hint text, metadata labels
* **Never mute primary content text**

**FORBIDDEN:**
* ‚ùå Never use `font-sans` for headings
* ‚ùå Never use `font-grotesk` for body text
* ‚ùå Never use `font-sans` for code/data displays

### Component Primitives

*Override default Shadcn sizes for enterprise feel.*

| Component | Specification | Usage |
| --- | --- | --- |
| **Buttons** | `size="sm"` (h-8 px-3) | **MANDATORY** in app context. Explicitly set, never omit. |
| **Inputs** | `h-9` (text-sm) | **MANDATORY** for all inputs. Never `h-10` or default. |
| **Cards** | `glass-card` or `bg-card border-border` | **MANDATORY**. Use `CardContent` with `pt-6`. |
| **Icons** | Navigation: `h-4 w-4`, Buttons: `h-3.5 w-3.5` | Lucide React only. |
| **Gradients** | `bg-rail-fade`, `bg-automation-flow` | Primary brand moments, CTAs. |

### Spacing System

*4px base unit (0.25rem). Reference `docs/UI_UX_GUIDE.md`.*

| Level | Spacing | Usage |
| --- | --- | --- |
| **Page Container** | `space-y-6 py-6` | **MANDATORY** for page-level. Never larger. |
| **Section** | `space-y-4` | Cards, tables, content sections. |
| **Form** | `space-y-2` or `space-y-3` | Form fields. Never `space-y-4`. |
| **Component** | `p-4` or `p-6` | Card padding. |

---

## 3. Master Application Shell

**‚ö†Ô∏è CRITICAL: The Master Application Shell is already implemented. All dashboard pages automatically inherit the shell structure.**

### Shell Components

The dashboard layout (`app/(dashboard)/layout.tsx`) provides:

1. **Sidebar** (`components/layout/sidebar.tsx`)
   - Fixed left, `w-64` (256px) ‚Äî **MANDATORY**
   - Logo + "Project Lazarus" in `font-grotesk`
   - Navigation: Projects, New Project, Billing, Settings
   - Active: `bg-sidebar-accent text-electric-cyan`
   - Inactive: `text-muted-foreground hover:bg-sidebar-accent/50`
   - User dropdown at bottom

2. **Main Content**
   - Offset by sidebar, full width on mobile
   - `flex-1 overflow-y-auto p-6`
   - Background: `bg-void-black`

### Usage Pattern

**Dashboard pages DO NOT need to create their own layout.**

```tsx
// ‚úÖ CORRECT - Page content only
export default function MyPage() {
  return (
    <div className="space-y-6 py-6">
      {/* Page content - shell is already provided */}
    </div>
  )
}

// ‚ùå WRONG - Don't recreate sidebar
export default function MyPage() {
  return (
    <div>
      <aside>...</aside> {/* WRONG - already in layout */}
    </div>
  )
}
```

### Adding Navigation Items

Update `components/layout/sidebar.tsx`:

```tsx
const navItems = [
  // ... existing items
  { label: "New Page", icon: IconName, href: "/new-page", match: (path) => path.startsWith("/new-page") },
]
```

---

## 4. The "Golden Page" Pattern

*Use this exact structure for all dashboard pages.*

```tsx
import { Suspense } from "react"
import { Skeleton } from "@/components/ui/skeleton"
import { Button } from "@/components/ui/button"
import { Plus } from "lucide-react"
import { DataList } from "./_components/data-list"

export default function Page() {
  return (
    <div className="space-y-6 py-6">
      <div className="flex items-center justify-between">
        <div className="space-y-1">
          <h1 className="font-grotesk text-lg font-semibold text-foreground">Page Title</h1>
          <p className="text-sm text-foreground mt-0.5">
            Clear, concise description of what this page does.
          </p>
        </div>
        <Button size="sm">
          <Plus className="mr-2 h-3.5 w-3.5" />
          Action
        </Button>
      </div>

      <div className="space-y-4">
        <Suspense fallback={<Skeleton className="h-[200px] w-full glass-card" />}>
          <DataList />
        </Suspense>
      </div>
    </div>
  )
}
```

**Key Requirements:**
* Use `space-y-6 py-6` for page container
* Use `font-grotesk` for page title
* Use `text-lg font-semibold` for title (never larger)
* Use `text-sm text-foreground` for description with `mt-0.5` (primary content‚Äînever muted)
* Always wrap data fetching in `<Suspense>` with Skeleton fallback
* Use Server Components by default

---

## 5. Project Lazarus UI Patterns

### Project Card

```tsx
<Card className="glass-card hover:glow-purple transition-all">
  <CardContent className="pt-6">
    <div className="flex items-start justify-between">
      <div className="space-y-1">
        <h3 className="font-grotesk text-sm font-medium text-foreground">Project Name</h3>
        <p className="text-xs text-muted-foreground line-clamp-2">Description</p>
      </div>
      <Badge variant="outline" className="text-[10px]">ready</Badge>
    </div>
    <div className="mt-4 flex items-center gap-2 text-xs text-muted-foreground">
      <span>Confidence: 85%</span>
    </div>
  </CardContent>
</Card>
```

### Glass Brain Panes

*Plan Pane, Work Pane, Thoughts Pane ‚Äî use `glass-panel` or `glass-card`.*

```tsx
<div className="glass-panel rounded-lg border border-border overflow-hidden">
  <div className="flex items-center justify-between px-4 py-2 border-b border-border">
    <span className="text-xs font-medium text-muted-foreground">Pane Title</span>
  </div>
  <div className="p-4 font-mono text-xs text-foreground overflow-x-auto">
    {/* Content */}
  </div>
</div>
```

### Confidence Gauge

*Use `font-grotesk` for the percentage, rail-purple/electric-cyan for active states.*

### Thought Signatures

*Use `font-sans text-sm text-foreground` for thought summary text.*

---

## 6. Micro-Interactions & Polish

1. **Hover States**: Cards: `hover:glow-purple` or `glass-card:hover`. Keep enterprise aesthetic.

2. **Loading States**: **MANDATORY**: Use Skeleton loaders (`<Skeleton />`). Use `Spinner` from `@shadcn/spinner` instead of `Loader2`.

3. **Motion**: Fade in: `animate-fade-in`. Spring: `{ stiffness: 400, damping: 30 }`. Keep subtle.

4. **Accessibility**: All inputs must have `<Label>` or `aria-label`. All images must have `alt` text. Icon-only buttons must have `aria-label`. Focus: `focus-visible:ring-2 focus-visible:ring-ring`. Support `prefers-reduced-motion` (see `brand/brand.md`).

---

## 7. üõë Hard Stops (Auto-Reject Code)

1. **No `useEffect` for data fetching**: Use Server Components + Suspense.

2. **No `bg-white` or `bg-black`**: Use `bg-card` or `bg-background`.

3. **No arbitrary colors**: Use design system tokens only. Never `bg-blue-500`, `text-red-400`.

4. **No default buttons**: Always specify `size="sm"` explicitly.

5. **No `Loader2`**: Use `Spinner` from `@shadcn/spinner` or `<Skeleton />`.

6. **No `font-sans` for headings**: Always use `font-grotesk`.

7. **No `font-grotesk` for code/data**: Always use `font-mono`.

8. **No `h-10` inputs**: Always use `h-9`.

9. **No manual memoization without profiling**: React Compiler handles this.

10. **No page titles larger than `text-lg`**: Page titles must be `text-lg font-semibold`.

11. **No ad-hoc Supabase clients**: Use `supabase` from `@/lib/db`.

12. **No `@google/genai` outside `lib/ai/gemini.ts`**: Use `getGeminiClient()` only.

---

## 8. Implementation Checklist

*Before outputting code, verify:*

**Design System:**
- [ ] Background is `bg-background` (`#0A0A0F`)
- [ ] Cards use `glass-card` or `bg-card border-border`
- [ ] Headings use `font-grotesk` (Space Grotesk)
- [ ] Body text uses `font-sans` (Inter) with `text-foreground`
- [ ] Code uses `font-mono` (JetBrains Mono)
- [ ] Page title is `text-lg font-semibold`
- [ ] Only design system colors used

**Components:**
- [ ] Buttons use `size="sm"` explicitly
- [ ] Inputs use `h-9`
- [ ] Icons use Lucide React
- [ ] Cards use `CardContent` with `pt-6`
- [ ] Dashboard pages don't recreate sidebar

**Code Quality:**
- [ ] Data fetching in Server Component with Suspense (no `useEffect`)
- [ ] No manual memoization (unless profiled)
- [ ] Supabase via `@/lib/db`
- [ ] Catch blocks type errors as `unknown`
- [ ] Third-party clients use lazy initialization
- [ ] Gemini via `getGeminiClient()` only

**States & UX:**
- [ ] Skeleton loaders for loading states
- [ ] Empty states with appropriate CTAs
- [ ] Error states with proper styling

**Accessibility (WCAG AA):**
- [ ] All inputs have `<Label>` or `aria-label`
- [ ] All images have descriptive `alt` text
- [ ] Icon-only buttons have `aria-label`
- [ ] Interactive elements keyboard navigable
- [ ] Focus states visible (`focus-visible:ring-ring`)
- [ ] No `text-rail-purple` on readable text

---

**Priority Order for References:**
1. **RULESETS.md** ‚Äî Mandatory code patterns (prevents build errors)
2. **docs/UI_UX_GUIDE.md** ‚Äî Complete design system documentation
3. **This file** ‚Äî Production rules and patterns
4. **Shadcn UI Documentation** ‚Äî Component implementation examples

**When guidelines conflict, prioritize RULESETS.md for code patterns and UI_UX_GUIDE.md for design decisions.**
